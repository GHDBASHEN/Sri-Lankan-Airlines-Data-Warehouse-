-- CREATE DATABASE (if needed)
CREATE DATABASE IF NOT EXISTS dw_srilankan;
USE dw_srilankan;

-- Dimension: date (use yyyymmdd int surrogate)
CREATE TABLE dim_date (
  date_key INT NOT NULL PRIMARY KEY, -- e.g., 20250910
  full_date DATE NOT NULL,
  year SMALLINT NOT NULL,
  quarter TINYINT NOT NULL,
  month TINYINT NOT NULL,
  day TINYINT NOT NULL,
  day_of_week TINYINT NOT NULL,
  is_weekend TINYINT(1) NOT NULL,
  holiday_name VARCHAR(128)
) ENGINE=InnoDB;

-- Dimension: airport
CREATE TABLE dim_airport (
  airport_key INT AUTO_INCREMENT PRIMARY KEY,
  iata CHAR(3) NOT NULL,
  icao CHAR(4),
  name VARCHAR(255),
  city VARCHAR(128),
  country VARCHAR(128),
  latitude DECIMAL(9,6),
  longitude DECIMAL(9,6),
  timezone VARCHAR(64),
  UNIQUE KEY ux_airport_iata (iata)
) ENGINE=InnoDB;

-- Dimension: aircraft (support SCD2 by versioning)
CREATE TABLE dim_aircraft (
  aircraft_key INT AUTO_INCREMENT PRIMARY KEY,
  tail_number VARCHAR(16),   -- if present
  model VARCHAR(64),
  manufacturer VARCHAR(64),
  seating_capacity INT,
  effective_from DATE,
  effective_to DATE,
  is_current TINYINT(1) DEFAULT 1,
  UNIQUE KEY ux_tail_period (tail_number, effective_from)
) ENGINE=InnoDB;

-- Dimension: flight metadata (flight number static)
CREATE TABLE dim_flight (
  flight_key INT AUTO_INCREMENT PRIMARY KEY,
  carrier_code VARCHAR(8),
  flight_number VARCHAR(16),
  published_duration_minutes INT,
  aircraft_type_default VARCHAR(64),
  UNIQUE KEY ux_flight (carrier_code, flight_number)
) ENGINE=InnoDB;

-- Dimension: passenger (consider encryption/hashing for PII)
CREATE TABLE dim_passenger (
  passenger_key INT AUTO_INCREMENT PRIMARY KEY,
  passenger_id_external VARCHAR(64), -- hashed externally if PII
  first_name VARCHAR(64),
  last_name VARCHAR(64),
  gender CHAR(1),
  dob DATE,
  country VARCHAR(64)
) ENGINE=InnoDB;

-- Fact table: flights (one row per flight occurrence)
CREATE TABLE fact_flights (
  flight_occurrence_key BIGINT AUTO_INCREMENT PRIMARY KEY,
  flight_key INT NOT NULL,
  aircraft_key INT,
  date_key INT NOT NULL,
  scheduled_dep_time TIME,
  scheduled_arr_time TIME,
  actual_dep_time TIME,
  actual_arr_time TIME,
  origin_airport_key INT,
  dest_airport_key INT,
  block_off DATETIME,
  block_on DATETIME,
  distance_km INT,
  seats_offered INT,
  seats_occupied INT,
  cancellations TINYINT(1) DEFAULT 0,
  delay_departure_minutes INT,
  delay_arrival_minutes INT,
  ontime TINYINT(1),
  load_factor DECIMAL(5,2), -- percent
  CONSTRAINT fk_ff_flight FOREIGN KEY (flight_key) REFERENCES dim_flight(flight_key),
  CONSTRAINT fk_ff_aircraft FOREIGN KEY (aircraft_key) REFERENCES dim_aircraft(aircraft_key),
  CONSTRAINT fk_ff_date FOREIGN KEY (date_key) REFERENCES dim_date(date_key),
  CONSTRAINT fk_ff_origin FOREIGN KEY (origin_airport_key) REFERENCES dim_airport(airport_key),
  CONSTRAINT fk_ff_dest FOREIGN KEY (dest_airport_key) REFERENCES dim_airport(airport_key)
) ENGINE=InnoDB;

-- Fact table: ticket sales / revenue (one row per ticket or aggregated per flight)
CREATE TABLE fact_ticket_sales (
  ticket_key BIGINT AUTO_INCREMENT PRIMARY KEY,
  flight_occurrence_key BIGINT,
  booking_ref VARCHAR(32),
  passenger_key INT,
  booking_date_key INT,
  fare_class VARCHAR(8),
  fare_amount DECIMAL(12,2),
  tax_amount DECIMAL(12,2),
  discount_amount DECIMAL(12,2),
  net_amount DECIMAL(12,2),
  payment_method VARCHAR(32),
  CONSTRAINT fk_ts_flightocc FOREIGN KEY (flight_occurrence_key) REFERENCES fact_flights(flight_occurrence_key),
  CONSTRAINT fk_ts_passenger FOREIGN KEY (passenger_key) REFERENCES dim_passenger(passenger_key),
  CONSTRAINT fk_ts_bookingdate FOREIGN KEY (booking_date_key) REFERENCES dim_date(date_key)
) ENGINE=InnoDB;

-- Indexes for common queries
CREATE INDEX idx_ff_date ON fact_flights(date_key);
CREATE INDEX idx_ff_route ON fact_flights(origin_airport_key, dest_airport_key);
CREATE INDEX idx_ts_bookingdate ON fact_ticket_sales(booking_date_key);
CREATE INDEX idx_ts_flightocc ON fact_ticket_sales(flight_occurrence_key);
